name: Self-Hosted Deploy

on:
  push:
    branches: [ main ] # –°—Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ –≤—ã –Ω–∞–∂–º–µ—Ç–µ Push –≤ –≤–µ—Ç–∫—É main

jobs:
  build_and_deploy:
    runs-on: self-hosted
    steps:
      - name: Notify Start
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üöÄ –î–µ–ø–ª–æ–π –Ω–∞—á–∞—Ç (–≤–µ—Ç–∫–∞: ${{ github.ref_name }})"

      - name: Check Changes & Pull
        id: check_step
        run: |
          cd ~/sitesender
          OLD_HASH=$(cat requirements.txt Containerfile | md5sum)
          git fetch origin main
          git reset --hard origin/main
          #git clean -fd
          NEW_HASH=$(cat requirements.txt Containerfile | md5sum)

          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "NEED_BUILD=true" >> $GITHUB_OUTPUT
            echo "MSG=–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞..." >> $GITHUB_ENV
          else
            echo "NEED_BUILD=false" >> $GITHUB_OUTPUT
            echo "MSG=–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫." >> $GITHUB_ENV
          fi

      - name: Notify Build Status
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üõ† ${{ env.MSG }}"

      - name: Build Image (if needed)
        if: steps.check_step.outputs.NEED_BUILD == 'true'
        run: |
          cd ~/sitesender
          podman build -t sitesender:latest .


      - name: Restart Service
        run: |
          systemctl --user daemon-reload
          systemctl --user restart container-sitesender-bot.service

      - name: Notify Success
        if: success()
        run: |
          MESSAGE="‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!%0A–¢–∏–ø: ${{ steps.check_step.outputs.NEED_BUILD == 'true' && '–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞' || '–ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç' }}%0A–ê–≤—Ç–æ—Ä: ${{ github.actor }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE"

      - name: Notify Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ!"

