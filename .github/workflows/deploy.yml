name: Optimized Deploy (Volumes)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    env:
      XDG_RUNTIME_DIR: /run/user/1003
      DBUS_SESSION_BUS_ADDRESS: unix:path=/run/user/1003/bus

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É ~/app
      - name: Sync Code
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          rsync -avz --exclude '.git*' ./ /home/github-runner/app/

      # 2. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å Containerfile –∏–ª–∏ requirements.txt
      - name: Build Image (if system files changed)
        id: build_check
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ git diff
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E 'Containerfile|requirements.txt'; then
            podman build -t sitesender:latest .
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi

      # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å, —á—Ç–æ–±—ã –±–æ—Ç –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –Ω–æ–≤—ã–π –∫–æ–¥ –∏–ª–∏ –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
      - name: Restart Bot
        run: |
          systemctl --user restart container-sitesender-bot.service

      - name: Notify Success
        if: success()
        run: |
          MSG="üöÄ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω! –û–±—Ä–∞–∑: ${{ steps.build_check.outputs.built == 'true' && '–û–±–Ω–æ–≤–ª–µ–Ω' || '–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π' }}"
          curl -s -X POST api.telegram.org{{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"
